{
  "variables": {
    "azure_client_id": "afa82da6-14bb-4a30-a5ba-38593ac7327e",
    "azure_object_id": "cb70e8e6-c00f-45fd-8876-dc39a323e13e",
    "azure_client_secret": "10IKFZMKf2H1cq]_q+S+YkjvKrjispE=",
    "azure_tenant_id": "335836de-42ef-43a2-b145-348c2ee9ca5b",
    "azure_subscription_id": "31d92081-230a-4230-acb8-c49587f53c7f",
    "azure_custom_image_resource_group_name": "image",
    "azure_custom_image_name": "winans-custom-latest_1.1",
    "azure_location": "East US",
    "azure_cloud_environment_name": "Public",
    "azure_os_type": "Windows",
    "azure_image_publisher": "MicrosoftWindowsServer",
    "azure_image_offer": "WindowsServer",
    "azure_image_sku": "2019-Datacenter"
   },

  "builders": [{
    "type": "azure-arm",

    "cloud_environment_name": "{{user `azure_cloud_environment_name`}}",

    "client_id": "{{user `azure_client_id`}}",
    "client_secret": "{{user `azure_client_secret`}}",
    "tenant_id": "{{user `azure_tenant_id`}}",
    "subscription_id": "{{user `azure_subscription_id`}}",

    "managed_image_resource_group_name": "{{user `azure_custom_image_resource_group_name`}}",
    "managed_image_name": "{{user `azure_custom_image_name`}}",

    "os_type": "{{user `azure_os_type`}}",
    "image_publisher": "{{user `azure_image_publisher`}}",
    "image_offer": "{{user `azure_image_offer`}}",
    "image_sku": "{{user `azure_image_sku`}}",

    "communicator": "winrm",
    "winrm_use_ssl": true,
    "winrm_insecure": true,
    "winrm_timeout": "5m",
    "winrm_username": "packer",

    "azure_tags": {
        "dept": "Engineering",
        "task": "Image deployment"
    },

    "location": "{{user `azure_location`}}",
    "vm_size": "{{user `azure_vm_size`}}"
  }],
  "provisioners": [
    {
      "type":  "ansible",
      "pause_before":"60s",
      "extra_arguments": [
        "--extra-vars", "ansible_shell_type=powershell ansible_shell_executable=None",
        "--connection", "packer"
     ],
      "playbook_file": "/etc/ansible/playbook.yml"
    },
    {
      "type": "powershell",
      "inline": ["Set-ItemProperty 'HKLM:/Software/Microsoft/Windows/CurrentVersion/RunOnce' -Name '!SetControls' -Value 'powershell.exe C:/Set-NonPersistentControls.ps1'"]
    },
    {
      "type": "file",
      "source": "/var/lib/jenkins/workspace/packer2/startUpScripts/Set-NonPersistentControl.ps1",
      "destination": "C:/Set-NonPersistentControls.ps1"
    },
    {
      "type": "powershell",
      "inline": [
        "echo '>>> Waiting for GA to start ...'",
        "while ((Get-Service RdAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
        "while ((Get-Service WindowsAzureTelemetryService).Status -ne 'Running') { Start-Sleep -s 5 }",
        "while ((Get-Service WindowsAzureGuestAgent).Status -ne 'Running') { Start-Sleep -s 5 }",

        "echo '>>> Sysprepping VM ...'",
        "if( Test-Path $Env:SystemRoot\\windows\\system32\\Sysprep\\unattend.xml ){ rm $Env:SystemRoot\\windows\\system32\\Sysprep\\unattend.xml -Force}",
        "& $Env:SystemRoot\\System32\\Sysprep\\Sysprep.exe /oobe /generalize /quiet /quit",
        "while($true) { $imageState = Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Setup\\State | Select ImageState; if($imageState.ImageState -ne 'IMAGE_STATE_GENERALIZE_RESEAL_TO_OOBE') { Write-Output $imageState.ImageState; Start-Sleep -s 5  } else { break } }"
      ]
    }
  ]
}